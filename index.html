<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monthly Dues Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">

<!-- FIREBASE â€” using compat CDN (most reliable for HTML files) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey:            "AIzaSyCA5hfET2P1H2axWtpdEEb94bSNfdmTi8o",
    authDomain:        "monthlyduestracker.firebaseapp.com",
    projectId:         "monthlyduestracker",
    storageBucket:     "monthlyduestracker.firebasestorage.app",
    messagingSenderId: "982537733144",
    appId:             "1:982537733144:web:da8adc15ea44eaf15f6f6d",
    databaseURL:       "https://monthlyduestracker-default-rtdb.asia-southeast1.firebasedatabase.app"
  };
  firebase.initializeApp(firebaseConfig);
</script>

<style>
:root {
  --bg:        #0d0f14;
  --panel:     #13161e;
  --card:      #191d27;
  --border:    #252a37;
  --accent:    #f5c842;
  --text:      #e8eaf0;
  --muted:     #6b7280;
  --danger:    #ef4444;
  --success:   #22c55e;
  --main-tag:  #3b82f6;
  --branch-tag:#a855f7;
  --tg:        #0088cc;
  --sidebar-w: 270px;
  --header-h:  64px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'DM Mono', monospace; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

/* HEADER */
header {
  height: var(--header-h);
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px;
  position: sticky; top: 0; z-index: 100;
}
.logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px; color: var(--accent); }
.logo span { color: var(--text); }
.header-right { display: flex; align-items: center; gap: 12px; }
.store-selector { display: flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.store-btn {
  padding: 6px 20px; background: transparent; border: none; color: var(--muted);
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.8rem; letter-spacing: 1px;
  cursor: pointer; transition: all .2s;
}
.store-btn.active-main   { background: var(--main-tag);   color: #fff; }
.store-btn.active-branch { background: var(--branch-tag); color: #fff; }
.uid-badge {
  font-size: 0.65rem; color: var(--muted); background: var(--card);
  border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px;
}
.settings-btn {
  width: 36px; height: 36px; border-radius: 8px;
  background: var(--card); border: 1px solid var(--border);
  color: var(--muted); font-size: 1.1rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: border-color .2s, color .2s;
}
.settings-btn:hover { border-color: var(--tg); color: #3ab4e8; }

/* LAYOUT */
.layout { display: flex; height: calc(100vh - var(--header-h)); }

/* SIDEBAR */
aside {
  width: var(--sidebar-w); background: var(--panel);
  border-left: 1px solid var(--border);
  overflow-y: auto; padding: 20px 16px; flex-shrink: 0;
  order: 2;
}
.sidebar-title {
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.7rem;
  letter-spacing: 2px; color: var(--muted); text-transform: uppercase;
  margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
}
.week-range { font-size: 0.65rem; color: var(--muted); margin-bottom: 6px; }
.week-total { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.05rem; color: var(--accent); }
.week-count { font-size: 0.6rem; color: var(--muted); margin-top: 3px; margin-bottom: 8px; }
.tg-btn {
  width: 100%; padding: 8px;
  background: #0088cc18; border: 1px solid #0088cc44;
  border-radius: 7px; color: #3ab4e8;
  font-size: 0.65rem; font-family: 'Syne', sans-serif; font-weight: 700; letter-spacing: 1px;
  cursor: pointer; transition: background .2s;
}
.tg-btn:hover { background: #0088cc33; }

/* MAIN */
main { flex: 1; overflow-y: auto; padding: 28px 32px; }
.page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 28px; }
.page-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.6rem; }
.store-pill { display: inline-block; padding: 3px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; margin-left: 10px; vertical-align: middle; }
.pill-main   { background: var(--main-tag);   color: #fff; }
.pill-branch { background: var(--branch-tag); color: #fff; }

/* FORM */
.add-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 24px; margin-bottom: 28px; }
.add-card h3 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.85rem; letter-spacing: 1px; color: var(--muted); text-transform: uppercase; margin-bottom: 18px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 12px; align-items: end; }
@media(max-width:900px){ .form-grid { grid-template-columns: 1fr 1fr; } }
label { display: block; font-size: 0.65rem; color: var(--muted); margin-bottom: 5px; letter-spacing: .5px; }
input, select {
  width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
  padding: 10px 13px; color: var(--text); font-family: 'DM Mono', monospace;
  font-size: 0.85rem; outline: none; transition: border-color .2s;
}
input:focus, select:focus { border-color: var(--accent); }
select option { background: var(--bg); }
.add-btn {
  height: 42px; padding: 0 22px; background: var(--accent); color: #0d0f14;
  border: none; border-radius: 8px; font-family: 'Syne', sans-serif; font-weight: 700;
  font-size: 0.85rem; cursor: pointer; transition: opacity .2s, transform .15s; white-space: nowrap;
}
.add-btn:hover { opacity: .85; transform: translateY(-1px); }

/* TABLE */
.table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.table-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; }
.month-nav { display: flex; align-items: center; gap: 10px; }
.nav-btn {
  background: var(--card); border: 1px solid var(--border); color: var(--text);
  width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 1rem;
  display: flex; align-items: center; justify-content: center; transition: border-color .2s;
}
.nav-btn:hover { border-color: var(--accent); }
.month-label { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.9rem; min-width: 130px; text-align: center; }
table { width: 100%; border-collapse: collapse; }
thead th {
  font-family: 'Syne', sans-serif; font-size: 0.65rem; letter-spacing: 1.5px;
  text-transform: uppercase; color: var(--muted); text-align: left;
  padding: 10px 14px; border-bottom: 1px solid var(--border);
}
tbody tr { border-bottom: 1px solid #252a3722; transition: background .15s; }
tbody tr:hover { background: var(--card); }
td { padding: 12px 14px; font-size: 0.82rem; }
.amount-cell { font-weight: 500; color: var(--accent); letter-spacing: .5px; }
.overdue { color: var(--danger) !important; }
.supplier-cell { color: #a8b2c8; }
.mode-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.65rem; font-weight: 500; border: 1px solid var(--border); color: var(--muted); }
.mode-cash     { border-color: #22c55e55; color: var(--success); }
.mode-check    { border-color: #f5c84255; color: var(--accent); }
.mode-transfer { border-color: #3b82f655; color: #60a5fa; }
.mode-gcash    { border-color: #a855f755; color: #c084fc; }
.del-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1rem; padding: 4px 8px; border-radius: 4px; transition: color .2s, background .2s; }
.del-btn:hover { color: var(--danger); background: #ef444422; }
.empty-state { text-align: center; padding: 60px 20px; color: var(--muted); font-size: 0.85rem; }
.empty-state .emoji { font-size: 2.5rem; margin-bottom: 12px; }
.total-row td { font-family: 'Syne', sans-serif; font-weight: 700; border-top: 2px solid var(--border); color: var(--accent); font-size: 0.9rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS (Settings + Recipient Picker)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed; inset: 0; background: #00000088;
  backdrop-filter: blur(4px);
  display: flex; align-items: center; justify-content: center;
  z-index: 500; opacity: 0; pointer-events: none; transition: opacity .25s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--panel); border: 1px solid var(--border); border-radius: 16px;
  width: 100%; max-width: 520px; padding: 28px;
  transform: translateY(16px); transition: transform .25s;
  max-height: 90vh; overflow-y: auto;
}
.modal-overlay.open .modal { transform: translateY(0); }
.modal-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;
}
.modal-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.1rem; }
.modal-close {
  background: none; border: none; color: var(--muted); font-size: 1.3rem; cursor: pointer;
  width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
  transition: background .2s, color .2s;
}
.modal-close:hover { background: var(--card); color: var(--text); }

/* Settings modal */
.settings-section { margin-bottom: 24px; }
.settings-section-title {
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.7rem;
  letter-spacing: 2px; text-transform: uppercase; color: var(--muted);
  margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
}
.token-row { display: flex; gap: 10px; align-items: flex-end; }
.token-row > div { flex: 1; }
.save-token-btn {
  height: 42px; padding: 0 18px; background: var(--tg); color: #fff; border: none;
  border-radius: 8px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.8rem;
  cursor: pointer; transition: opacity .2s; white-space: nowrap;
}
.save-token-btn:hover { opacity: .85; }

/* Recipient list */
.recipient-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; }
.recipient-item {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--card); border: 1px solid var(--border); border-radius: 9px; padding: 10px 14px;
}
.recipient-info .r-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem; }
.recipient-info .r-chatid { font-size: 0.68rem; color: var(--muted); margin-top: 2px; }
.r-del-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.9rem; padding: 4px 8px; border-radius: 4px; transition: color .2s; }
.r-del-btn:hover { color: var(--danger); }
.add-recipient-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end; }
.add-recipient-btn {
  height: 42px; padding: 0 16px; background: var(--card); border: 1px solid var(--border);
  color: var(--text); border-radius: 8px; font-family: 'Syne', sans-serif; font-weight: 700;
  font-size: 0.8rem; cursor: pointer; white-space: nowrap; transition: border-color .2s;
}
.add-recipient-btn:hover { border-color: var(--accent); }
.empty-recipients { text-align: center; padding: 20px; color: var(--muted); font-size: 0.78rem; border: 1px dashed var(--border); border-radius: 8px; }

/* Recipient Picker Modal (for sending) */
.picker-modal { max-width: 380px; }
.picker-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
.picker-item {
  display: flex; align-items: center; gap: 12px;
  background: var(--card); border: 1px solid var(--border); border-radius: 9px;
  padding: 12px 14px; cursor: pointer; transition: border-color .2s, background .2s;
}
.picker-item:hover { border-color: var(--tg); background: #0088cc11; }
.picker-item.selected { border-color: var(--tg); background: #0088cc1a; }
.picker-check {
  width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--border);
  flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  font-size: 0.6rem; transition: all .2s;
}
.picker-item.selected .picker-check { background: var(--tg); border-color: var(--tg); color: #fff; }
.picker-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.85rem; }
.picker-chatid { font-size: 0.65rem; color: var(--muted); }
.send-selected-btn {
  width: 100%; padding: 12px; background: var(--tg); color: #fff; border: none;
  border-radius: 9px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.85rem;
  cursor: pointer; transition: opacity .2s; margin-top: 8px;
}
.send-selected-btn:hover { opacity: .85; }
.send-selected-btn:disabled { opacity: .4; cursor: not-allowed; }
.send-all-btn {
  width: 100%; padding: 10px; background: transparent; border: 1px solid var(--tg);
  color: #3ab4e8; border-radius: 9px; font-family: 'Syne', sans-serif; font-weight: 700;
  font-size: 0.8rem; cursor: pointer; transition: background .2s; margin-top: 6px;
}
.send-all-btn:hover { background: #0088cc18; }

/* TOAST */
#toast {
  position: fixed; bottom: 28px; right: 28px; background: var(--card);
  border: 1px solid var(--border); border-radius: 10px; padding: 14px 20px;
  font-size: 0.82rem; opacity: 0; transform: translateY(10px);
  transition: all .3s; z-index: 9999; pointer-events: none; max-width: 320px;
}
#toast.show { opacity: 1; transform: translateY(0); }
#toast.success { border-color: var(--success); color: var(--success); }
#toast.error   { border-color: var(--danger);  color: var(--danger); }
#toast.info    { border-color: var(--tg);       color: #3ab4e8; }


/* LIGHT THEME */
body.light {
  --bg:        #f0f2f7;
  --panel:     #ffffff;
  --card:      #f7f8fc;
  --border:    #dde1ec;
  --accent:    #d4a017;
  --text:      #1a1d27;
  --muted:     #7a8099;
  --danger:    #dc2626;
  --success:   #16a34a;
  --main-tag:  #2563eb;
  --branch-tag:#9333ea;
  --tg:        #0088cc;
}
body.light .week-card.collapsed { background: #eaecf3; }
body.light tbody tr:hover { background: #eef0f8; }
body.light .supplier-cell { color: #4a5270; }

/* THEME TOGGLE */
.theme-btn {
  width: 36px; height: 36px; border-radius: 8px;
  background: var(--card); border: 1px solid var(--border);
  color: var(--muted); font-size: 1.05rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: border-color .2s, color .2s;
}
.theme-btn:hover { border-color: var(--accent); color: var(--accent); }

/* STORE SPLASH */
#store-splash {
  position: fixed; inset: 0;
  background: var(--bg);
  display: flex; align-items: center; justify-content: center;
  z-index: 9000;
  transition: opacity .4s, transform .4s;
}
#store-splash.hiding { opacity: 0; transform: scale(1.04); pointer-events: none; }
.splash-box {
  text-align: center; max-width: 420px; width: 90%; padding: 0 16px;
}
.splash-logo {
  font-family: 'Syne', sans-serif; font-weight: 800; font-size: 2rem;
  color: var(--accent); letter-spacing: -1px; margin-bottom: 6px;
}
.splash-logo span { color: var(--text); }
.splash-subtitle {
  font-size: 0.78rem; color: var(--muted); margin-bottom: 40px; letter-spacing: .5px;
}
.splash-prompt {
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.72rem;
  letter-spacing: 2px; text-transform: uppercase; color: var(--muted);
  margin-bottom: 18px;
}
.splash-stores { display: flex; gap: 16px; justify-content: center; }
.splash-store-btn {
  flex: 1; max-width: 170px; padding: 28px 16px;
  border-radius: 16px; border: 2px solid var(--border);
  background: var(--card); cursor: pointer;
  transition: border-color .2s, box-shadow .2s, transform .15s;
  display: flex; flex-direction: column; align-items: center; gap: 10px;
}
.splash-store-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,.15); }
.splash-store-btn.main-opt:hover  { border-color: var(--main-tag); }
.splash-store-btn.branch-opt:hover { border-color: var(--branch-tag); }
.splash-store-icon { font-size: 2.2rem; }
.splash-store-label {
  font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1rem; letter-spacing: 1px;
}
.splash-store-btn.main-opt   .splash-store-label { color: var(--main-tag); }
.splash-store-btn.branch-opt .splash-store-label { color: var(--branch-tag); }
.splash-store-desc { font-size: 0.65rem; color: var(--muted); }

/* THRESHOLD */
.threshold-bar-wrap {
  margin: 0 0 8px 0;
  background: var(--bg); border-radius: 8px; overflow: hidden;
  height: 6px; border: 1px solid var(--border);
}
.threshold-bar {
  height: 100%; border-radius: 8px;
  transition: width .4s ease, background .3s;
  background: var(--success);
}
.threshold-bar.warn  { background: #f59e0b; }
.threshold-bar.over  { background: var(--danger); }
.threshold-status {
  display: flex; justify-content: space-between; align-items: center;
  font-size: 0.62rem; color: var(--muted); margin-bottom: 10px;
}
.threshold-status .ts-remaining { font-family: 'Syne', sans-serif; font-weight: 700; }
.threshold-status .ts-remaining.warn  { color: #f59e0b; }
.threshold-status .ts-remaining.over  { color: var(--danger); }
.threshold-status .ts-remaining.safe  { color: var(--success); }
.threshold-exceeded-banner {
  background: #ef444418; border: 1px solid #ef444455;
  border-radius: 8px; padding: 8px 12px; margin-bottom: 10px;
  font-size: 0.68rem; color: var(--danger);
  font-family: 'Syne', sans-serif; font-weight: 700;
  display: flex; align-items: center; gap: 6px;
}
.threshold-warn-banner {
  background: #f59e0b18; border: 1px solid #f59e0b55;
  border-radius: 8px; padding: 8px 12px; margin-bottom: 10px;
  font-size: 0.68rem; color: #f59e0b;
  font-family: 'Syne', sans-serif; font-weight: 700;
  display: flex; align-items: center; gap: 6px;
}
.threshold-set-row {
  display: flex; align-items: center; gap: 6px; margin-bottom: 14px;
  padding-bottom: 14px; border-bottom: 1px solid var(--border);
}
.threshold-set-row input {
  flex: 1; padding: 7px 10px; font-size: 0.78rem;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 7px; color: var(--text); font-family: 'DM Mono', monospace;
  outline: none; transition: border-color .2s;
  width: auto;
}
.threshold-set-row input:focus { border-color: var(--accent); }
.threshold-set-btn {
  padding: 7px 12px; background: var(--accent); color: #0d0f14;
  border: none; border-radius: 7px; font-family: 'Syne', sans-serif;
  font-weight: 700; font-size: 0.68rem; cursor: pointer;
  white-space: nowrap; transition: opacity .2s;
}
.threshold-set-btn:hover { opacity: .85; }
.threshold-clear-btn {
  padding: 7px 10px; background: transparent; color: var(--muted);
  border: 1px solid var(--border); border-radius: 7px;
  font-size: 0.68rem; cursor: pointer; transition: color .2s, border-color .2s;
  white-space: nowrap;
}
.threshold-clear-btn:hover { color: var(--danger); border-color: var(--danger); }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

/* WEEK CARD â€” collapsible + detail */
.week-card {
  background: var(--card); border: 1px solid var(--border); border-radius: 10px;
  margin-bottom: 10px; transition: border-color .2s, box-shadow .2s; overflow: hidden;
}
.week-card:hover { border-color: #3d4559; }
.week-card.collapsed {
  background: #14171f;
  border: 1px dashed var(--border);
  opacity: 0.85;
}
.week-card.collapsed:hover {
  opacity: 1;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(245,200,66,.15);
}
.week-card-header {
  padding: 12px 14px; cursor: pointer; user-select: none;
  display: flex; justify-content: space-between; align-items: center;
}
.week-card-header:hover { background: rgba(245,200,66,.04); }
.week-card-meta { flex: 1; }
.week-card-chevron {
  font-size: 0.85rem; color: var(--muted); margin-left: 8px;
  transition: transform .25s; flex-shrink: 0; line-height: 1;
}
.week-card.collapsed .week-card-chevron { transform: rotate(-90deg); }
.week-card-body {
  max-height: 600px; overflow: hidden;
  transition: max-height .3s ease, opacity .25s;
  opacity: 1;
}
.week-card.collapsed .week-card-body { max-height: 0; opacity: 0; }
.week-card-body-inner { padding: 0 14px 12px 14px; }
.week-past-badge {
  display: inline-block; font-size: 0.55rem; letter-spacing: .5px;
  background: #ef444422; border: 1px solid #ef444444; color: var(--danger);
  border-radius: 20px; padding: 1px 7px; margin-left: 6px; vertical-align: middle;
}
/* collapsed header: show everything horizontally */
.week-card.collapsed .week-card-meta {
  display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
}
.week-card.collapsed .week-range { margin-bottom: 0; }
.week-card.collapsed .week-total { font-size: 0.88rem; }
.week-card.collapsed .week-count { margin: 0; }
.due-detail-row {
  display: flex; flex-direction: column; gap: 2px;
  padding: 8px 0; border-bottom: 1px solid #252a3730;
  font-size: 0.72rem;
}
.due-detail-row:last-child { border-bottom: none; }
.due-detail-supplier { font-family: 'Syne', sans-serif; font-weight: 700; color: var(--text); font-size: 0.78rem; }
.due-detail-line { color: var(--muted); display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
.due-detail-amount { color: var(--accent); font-weight: 500; }
.due-detail-mode-badge { display: inline-block; padding: 1px 7px; border-radius: 20px; font-size: 0.6rem; border: 1px solid var(--border); color: var(--muted); }
.due-detail-mode-cash     { border-color: #22c55e55; color: var(--success); }
.due-detail-mode-check    { border-color: #f5c84255; color: var(--accent); }
.due-detail-mode-transfer { border-color: #3b82f655; color: #60a5fa; }
.due-detail-mode-gcash    { border-color: #a855f755; color: #c084fc; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo">Dues<span>Track</span></div>
  <div class="header-right">
    <div class="store-selector">
      <button class="store-btn active-main" id="btn-main"   onclick="setStore('MAIN')">MAIN</button>
      <button class="store-btn"             id="btn-branch" onclick="setStore('BRANCH')">BRANCH</button>
    </div>
    <button class="theme-btn" id="theme-btn" onclick="toggleTheme()" title="Toggle theme">ğŸŒ™</button>
    <button class="settings-btn" onclick="openSettings()" title="Telegram Settings">âš™ï¸</button>
    <div class="uid-badge" id="uid-badge">â³ connectingâ€¦</div>
  </div>
</header>

<div class="layout">

  <!-- â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â• -->
  <aside>
    <div class="sidebar-title">Weekly Summary</div>
    <!-- Threshold setter -->
    <div class="threshold-set-row">
      <input type="text" id="threshold-input" placeholder="Weekly limit â‚±" oninput="formatThresholdInput(this)">
      <button class="threshold-set-btn" onclick="saveThreshold()">SET</button>
      <button class="threshold-clear-btn" onclick="clearThreshold()" title="Remove limit">âœ•</button>
    </div>
    <div id="week-list"><div style="color:var(--muted);font-size:.75rem;text-align:center;padding:20px 0">Loadingâ€¦</div></div>
  </aside>

  <!-- â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â• -->
  <main>
    <div class="page-header">
      <div>
        <span class="page-title">Payment Dues</span>
        <span class="store-pill pill-main" id="store-pill">MAIN</span>
      </div>
    </div>

    <!-- ADD FORM -->
    <div class="add-card">
      <h3>+ Add New Due</h3>
      <div class="form-grid">
        <div><label>DUE DATE</label><input type="date" id="f-date"></div>
        <div><label>AMOUNT (â‚±)</label><input type="text" id="f-amount" placeholder="0.00" oninput="formatAmountInput(this)"></div>
        <div><label>SUPPLIER / PAYEE</label><input type="text" id="f-supplier" placeholder="e.g. Globe Telecom"></div>
        <div>
          <label>MODE OF PAYMENT</label>
          <select id="f-mode">
            <option value="Cash">Cash</option>
            <option value="Check">Check</option>
            <option value="Bank Transfer">Bank Transfer</option>
            <option value="GCash">GCash</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <button class="add-btn" onclick="addDue()">ADD DUE</button>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-header">
      <div class="table-title">Due Entries</div>
      <div class="month-nav">
        <button class="nav-btn" onclick="changeMonth(-1)">â€¹</button>
        <div class="month-label" id="month-label">â€”</div>
        <button class="nav-btn" onclick="changeMonth(1)">â€º</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Due Date</th><th>Supplier / Payee</th><th>Mode of Payment</th><th>Amount</th><th></th>
        </tr>
      </thead>
      <tbody id="dues-body"><tr><td colspan="5"><div class="empty-state"><div class="emoji">ğŸ“‹</div>No dues yet.</div></td></tr></tbody>
      <tfoot  id="dues-foot"></tfoot>
    </table>
  </main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SETTINGS MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="settings-overlay" onclick="overlayClose(event,'settings-overlay')">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">âš™ï¸ Telegram Settings</div>
      <button class="modal-close" onclick="closeSettings()">âœ•</button>
    </div>

    <!-- Bot Token -->
    <div class="settings-section">
      <div class="settings-section-title">ğŸ¤– Bot Token</div>
      <div class="token-row">
        <div>
          <label>BOT TOKEN</label>
          <input type="text" id="s-token" placeholder="e.g. 123456:ABCdef...">
        </div>
        <button class="save-token-btn" onclick="saveToken()">SAVE</button>
      </div>
      <div style="font-size:.65rem;color:var(--muted);margin-top:8px;">Get your token from <strong style="color:#3ab4e8">@BotFather</strong> on Telegram.</div>
    </div>

    <!-- Recipients -->
    <div class="settings-section">
      <div class="settings-section-title">ğŸ‘¥ Recipients</div>
      <div id="recipient-list-ui"></div>

      <!-- Add recipient -->
      <div class="add-recipient-grid" style="margin-top:12px;">
        <div><label>NAME</label><input type="text" id="r-name" placeholder="e.g. Owner"></div>
        <div><label>CHAT ID</label><input type="text" id="r-chatid" placeholder="e.g. -100123456"></div>
        <button class="add-recipient-btn" onclick="addRecipient()">+ ADD</button>
      </div>
      <div style="font-size:.65rem;color:var(--muted);margin-top:8px;">To get a Chat ID: forward a message to <strong style="color:#3ab4e8">@userinfobot</strong> on Telegram.</div>
    </div>

    <button class="save-token-btn" style="width:100%;margin-top:4px;" onclick="closeSettings()">DONE</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• RECIPIENT PICKER MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="picker-overlay" onclick="overlayClose(event,'picker-overlay')">
  <div class="modal picker-modal">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¨ Send via Telegram</div>
      <button class="modal-close" onclick="closePicker()">âœ•</button>
    </div>
    <div style="font-size:.72rem;color:var(--muted);margin-bottom:14px;" id="picker-week-label"></div>
    <div class="picker-list" id="picker-list"></div>
    <button class="send-selected-btn" id="send-selected-btn" onclick="sendToSelected()" disabled>Send to Selected</button>
    <button class="send-all-btn" onclick="sendToAll()">Send to All Recipients</button>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â• STORE SPLASH â•â•â•â•â•â•â•â•â•â•â• -->
<div id="store-splash">
  <div class="splash-box">
    <div class="splash-logo">Dues<span>Track</span></div>
    <div class="splash-subtitle">Monthly Payment Tracker</div>
    <div class="splash-prompt">Which store are you managing?</div>
    <div class="splash-stores">
      <button class="splash-store-btn main-opt" onclick="pickStore('MAIN')">
        <div class="splash-store-icon">ğŸª</div>
        <div class="splash-store-label">MAIN</div>
        <div class="splash-store-desc">Main Store</div>
      </button>
      <button class="splash-store-btn branch-opt" onclick="pickStore('BRANCH')">
        <div class="splash-store-icon">ğŸ¬</div>
        <div class="splash-store-label">BRANCH</div>
        <div class="splash-store-desc">Branch Store</div>
      </button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyTheme(t) {
  document.body.classList.toggle('light', t === 'light');
  document.getElementById('theme-btn').textContent = t === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('theme', t);
}
function toggleTheme() {
  applyTheme(document.body.classList.contains('light') ? 'dark' : 'light');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORE SPLASH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pickStore(s) {
  currentStore = s;
  loadThreshold();
  // Update header buttons and pill
  document.getElementById('btn-main').className   = 'store-btn' + (s === 'MAIN'   ? ' active-main'   : '');
  document.getElementById('btn-branch').className = 'store-btn' + (s === 'BRANCH' ? ' active-branch' : '');
  const pill = document.getElementById('store-pill');
  pill.textContent = s; pill.className = 'store-pill ' + (s === 'MAIN' ? 'pill-main' : 'pill-branch');
  // Animate splash out
  const splash = document.getElementById('store-splash');
  splash.classList.add('hiding');
  setTimeout(() => { splash.style.display = 'none'; }, 420);
  loadDues();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentStore = 'MAIN';
let currentUID   = null;
let allDues      = [];
const today      = new Date();
let viewYear     = today.getFullYear();
let viewMonth    = today.getMonth();

// Telegram state
let tgToken      = '';
let tgRecipients = []; // [{name, chatId}]
let pickerWeekIndex = null;
let selectedRecipients = new Set();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TELEGRAM SETTINGS â€” persist in localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadTgSettings() {
  tgToken      = localStorage.getItem('tg_token') || '';
  try { tgRecipients = JSON.parse(localStorage.getItem('tg_recipients') || '[]'); }
  catch(e) { tgRecipients = []; }
}

function saveTgSettings() {
  localStorage.setItem('tg_token',      tgToken);
  localStorage.setItem('tg_recipients', JSON.stringify(tgRecipients));
}

function saveToken() {
  const val = document.getElementById('s-token').value.trim();
  if (!val) { showToast('Enter a bot token first.', 'error'); return; }
  tgToken = val;
  saveTgSettings();
  showToast('Bot token saved! âœ…', 'success');
}

function addRecipient() {
  const name   = document.getElementById('r-name').value.trim();
  const chatId = document.getElementById('r-chatid').value.trim();
  if (!name || !chatId) { showToast('Enter both name and Chat ID.', 'error'); return; }
  tgRecipients.push({ name, chatId });
  saveTgSettings();
  document.getElementById('r-name').value   = '';
  document.getElementById('r-chatid').value = '';
  renderRecipientListUI();
  showToast(`Recipient "${name}" added!`, 'success');
}

function removeRecipient(i) {
  tgRecipients.splice(i, 1);
  saveTgSettings();
  renderRecipientListUI();
}

function renderRecipientListUI() {
  const el = document.getElementById('recipient-list-ui');
  if (!tgRecipients.length) {
    el.innerHTML = '<div class="empty-recipients">No recipients yet. Add one below.</div>';
    return;
  }
  el.innerHTML = '<div class="recipient-list">' +
    tgRecipients.map((r,i) => `
      <div class="recipient-item">
        <div class="recipient-info">
          <div class="r-name">${escHtml(r.name)}</div>
          <div class="r-chatid">Chat ID: ${escHtml(r.chatId)}</div>
        </div>
        <button class="r-del-btn" onclick="removeRecipient(${i})" title="Remove">âœ•</button>
      </div>
    `).join('') +
  '</div>';
}

function openSettings() {
  loadTgSettings();
  document.getElementById('s-token').value = tgToken;
  renderRecipientListUI();
  document.getElementById('settings-overlay').classList.add('open');
}
function closeSettings() { document.getElementById('settings-overlay').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECIPIENT PICKER MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPicker(weekIndex) {
  loadTgSettings();

  if (!tgToken) {
    showToast('Set your Bot Token in âš™ï¸ Settings first.', 'error'); return;
  }
  if (!tgRecipients.length) {
    showToast('Add at least one recipient in âš™ï¸ Settings first.', 'error'); return;
  }

  pickerWeekIndex  = weekIndex;
  selectedRecipients = new Set();
  const w = (window.__weeks || [])[weekIndex];
  document.getElementById('picker-week-label').textContent =
    w ? 'Week: ' + w.label + '  â€¢  â‚±' + formatPeso(w.total) : '';

  renderPickerList();
  document.getElementById('settings-overlay').classList.remove('open');
  document.getElementById('picker-overlay').classList.add('open');
}
function closePicker() { document.getElementById('picker-overlay').classList.remove('open'); }

function renderPickerList() {
  const el = document.getElementById('picker-list');
  el.innerHTML = tgRecipients.map((r,i) => `
    <div class="picker-item ${selectedRecipients.has(i) ? 'selected' : ''}" onclick="toggleRecipient(${i})">
      <div class="picker-check">${selectedRecipients.has(i) ? 'âœ“' : ''}</div>
      <div>
        <div class="picker-name">${escHtml(r.name)}</div>
        <div class="picker-chatid">Chat ID: ${escHtml(r.chatId)}</div>
      </div>
    </div>
  `).join('');
  document.getElementById('send-selected-btn').disabled = selectedRecipients.size === 0;
}

function toggleRecipient(i) {
  if (selectedRecipients.has(i)) selectedRecipients.delete(i);
  else selectedRecipients.add(i);
  renderPickerList();
}

async function sendToSelected() {
  const targets = [...selectedRecipients].map(i => tgRecipients[i]);
  await doSend(targets);
}

async function sendToAll() {
  await doSend(tgRecipients);
}

async function doSend(targets) {
  if (!targets.length) { showToast('No recipients selected.', 'error'); return; }
  const w = (window.__weeks || [])[pickerWeekIndex];
  if (!w) return;

  const lines = w.dues.map(d =>
    `  â€¢ ${formatDate(d.dueDate)} | ${d.supplier} | ${d.mode} | â‚±${formatPeso(d.amount)}`
  ).join('\n');

  const msg =
`ğŸ“… *Weekly Dues Report*
ğŸª Store: *${currentStore}*
ğŸ“† Week: ${w.label}

${lines}

ğŸ’° *Total: â‚±${formatPeso(w.total)}*
ğŸ”¢ ${w.count} due${w.count !== 1 ? 's' : ''}`;

  let ok = 0, fail = 0;
  for (const r of targets) {
    try {
      const res  = await fetch(`https://api.telegram.org/bot${tgToken}/sendMessage`, {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: r.chatId, text: msg, parse_mode: 'Markdown' })
      });
      const data = await res.json();
      if (data.ok) ok++;
      else { fail++; console.warn('TG error for', r.name, data.description); }
    } catch(e) { fail++; }
  }

  closePicker();
  if (fail === 0) showToast(`Sent to ${ok} recipient${ok !== 1 ? 's' : ''}! ğŸ“¨`, 'success');
  else            showToast(`Sent: ${ok} âœ…  Failed: ${fail} âŒ`, fail > 0 ? 'error' : 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERLAY CLOSE ON BACKDROP CLICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function overlayClose(e, id) {
  if (e.target.id === id) document.getElementById(id).classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE INIT â€” using compat SDK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getOrCreateDeviceUID() {
  let uid = localStorage.getItem('device_uid');
  if (!uid) {
    uid = 'dev_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 9);
    localStorage.setItem('device_uid', uid);
  }
  return uid;
}

function initApp() {
  const badge = document.getElementById('uid-badge');

  // Apply saved theme
  applyTheme(localStorage.getItem('theme') || 'dark');

  currentUID = getOrCreateDeviceUID();
  badge.textContent = 'ID: ' + currentUID.slice(0, 14) + '...';
  badge.title = 'Click to copy Device ID';
  badge.style.cursor = 'pointer';
  badge.onclick = () => {
    navigator.clipboard.writeText(currentUID).then(() => showToast('Device ID copied! ğŸ“‹', 'success'));
  };
  // loadDues() is called after store selection in pickStore()
}
window.addEventListener('load', initApp);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCALSTORAGE FALLBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function localKey()      { return `dues_${currentUID}_${currentStore}`; }
function localLoad()     { try { return JSON.parse(localStorage.getItem(localKey()) || '[]'); } catch(e) { return []; } }
function localSave(data) { localStorage.setItem(localKey(), JSON.stringify(data)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD DUES â€” Realtime Database compat
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let __dbRef      = null;
let __dbCallback = null;
function loadDues() {
  if (!currentUID) return;
  // Properly detach previous listener before switching
  if (__dbRef && __dbCallback) {
    __dbRef.off('value', __dbCallback);
    __dbRef = null; __dbCallback = null;
  }

  try {
    __dbRef = firebase.database().ref(`dues/${currentUID}/${currentStore}`);
    __dbCallback = __dbRef.on('value', snap => {
      const data = snap.val();
      allDues = data
        ? Object.entries(data).map(([id, v]) => ({ id, ...v }))
        : [];
      allDues.sort((a,b) => a.dueDate.localeCompare(b.dueDate));
      renderTable();
      renderSidebar();
    }, e => {
      console.warn('RTDB error:', e.message);
      if (e.message && e.message.toLowerCase().includes('permission')) {
        showToast('âš  Firebase permission denied. Update your DB rules to allow read/write.', 'error');
      }
      allDues = localLoad();
      renderTable(); renderSidebar();
    });
  } catch(e) {
    allDues = localLoad();
    renderTable(); renderSidebar();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD DUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addDue() {
  const dateVal   = document.getElementById('f-date').value;
  const amountRaw = document.getElementById('f-amount').value.replace(/,/g,'');
  const supplier  = document.getElementById('f-supplier').value.trim();
  const mode      = document.getElementById('f-mode').value;
  if (!dateVal || !amountRaw || !supplier) { showToast('Please fill in all fields.', 'error'); return; }
  const amount = parseFloat(amountRaw);
  if (isNaN(amount) || amount <= 0) { showToast('Enter a valid amount.', 'error'); return; }
  const entry = { uid: currentUID, store: currentStore, dueDate: dateVal, amount, supplier, mode, createdAt: new Date().toISOString() };
  try {
    if (currentUID !== 'local-user') {
      await firebase.database().ref(`dues/${currentUID}/${currentStore}`).push(entry);
      // realtime listener will auto-refresh
    } else {
      entry.id = 'local_' + Date.now();
      allDues.push(entry);
      allDues.sort((a,b) => a.dueDate.localeCompare(b.dueDate));
      localSave(allDues);
      renderTable(); renderSidebar();
    }
    showToast('Due added! âœ…', 'success');
    clearForm();
    const d = new Date(dateVal + 'T00:00:00');
    viewYear = d.getFullYear(); viewMonth = d.getMonth();
  } catch(e) { showToast('Error saving: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE DUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deleteDue(id) {
  if (!confirm('Remove this due entry?')) return;
  try {
    if (currentUID !== 'local-user' && !id.startsWith('local_')) {
      await firebase.database().ref(`dues/${currentUID}/${currentStore}/${id}`).remove();
      // realtime listener will auto-refresh
    } else {
      allDues = allDues.filter(d => d.id !== id);
      localSave(allDues);
      renderTable(); renderSidebar();
    }
    showToast('Entry deleted.', 'info');
  } catch(e) { showToast('Error deleting: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function renderTable() {
  document.getElementById('month-label').textContent = MONTHS[viewMonth] + ' ' + viewYear;
  const filtered = allDues.filter(d => {
    const dt = new Date(d.dueDate + 'T00:00:00');
    return dt.getFullYear() === viewYear && dt.getMonth() === viewMonth;
  });
  const tbody = document.getElementById('dues-body');
  const tfoot = document.getElementById('dues-foot');
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="emoji">ğŸ“‹</div>No dues for ${MONTHS[viewMonth]} ${viewYear}.</div></td></tr>`;
    tfoot.innerHTML = ''; return;
  }
  const todayStr = today.toISOString().slice(0,10);
  tbody.innerHTML = filtered.map(d => {
    const overdue = d.dueDate < todayStr;
    const modeClass = {'Cash':'mode-cash','Check':'mode-check','Bank Transfer':'mode-transfer','GCash':'mode-gcash'}[d.mode] || '';
    return `<tr>
      <td class="due-date-cell ${overdue ? 'overdue' : ''}">${formatDate(d.dueDate)}${overdue ? ' âš ' : ''}</td>
      <td class="supplier-cell">${escHtml(d.supplier)}</td>
      <td><span class="mode-badge ${modeClass}">${escHtml(d.mode)}</span></td>
      <td class="amount-cell">â‚± ${formatPeso(d.amount)}</td>
      <td><button class="del-btn" onclick="deleteDue('${d.id}')" title="Delete">âœ•</button></td>
    </tr>`;
  }).join('');
  const total = filtered.reduce((s,d) => s + d.amount, 0);
  tfoot.innerHTML = `<tr class="total-row">
    <td colspan="3" style="text-align:right;color:var(--muted);font-size:.7rem;letter-spacing:1px;">TOTAL FOR ${MONTHS[viewMonth].toUpperCase()}</td>
    <td class="amount-cell">â‚± ${formatPeso(total)}</td><td></td>
  </tr>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEEKLY THRESHOLD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let weeklyThreshold = 0;

function loadThreshold() {
  const saved = parseFloat(localStorage.getItem('weekly_threshold_' + currentStore));
  weeklyThreshold = isNaN(saved) ? 0 : saved;
  const inp = document.getElementById('threshold-input');
  if (inp) inp.value = weeklyThreshold > 0 ? formatPeso(weeklyThreshold) : '';
}

function saveThreshold() {
  const raw = document.getElementById('threshold-input').value.replace(/,/g, '');
  const val = parseFloat(raw);
  if (isNaN(val) || val <= 0) { showToast('Enter a valid threshold amount.', 'error'); return; }
  weeklyThreshold = val;
  localStorage.setItem('weekly_threshold_' + currentStore, val);
  document.getElementById('threshold-input').value = formatPeso(val);
  renderSidebar();
  showToast('Weekly limit set to â‚±' + formatPeso(val) + ' âœ…', 'success');
}

function clearThreshold() {
  weeklyThreshold = 0;
  localStorage.removeItem('weekly_threshold_' + currentStore);
  document.getElementById('threshold-input').value = '';
  renderSidebar();
  showToast('Weekly limit removed.', 'info');
}

function formatThresholdInput(el) {
  let raw = el.value.replace(/[^0-9.]/g, '');
  const parts = raw.split('.');
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  el.value = parts.length > 2 ? parts[0] + '.' + parts.slice(1).join('') : parts.join('.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER SIDEBAR â€” Sat â†’ Fri weeks
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  loadThreshold();
  const weeks = groupByWeeks(allDues);
  const el    = document.getElementById('week-list');
  if (!weeks.length) { el.innerHTML = '<div style="color:var(--muted);font-size:.72rem;text-align:center;padding:20px 0">No dues yet.</div>'; return; }

  const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  let hasAlerted = false;

  el.innerHTML = weeks.map((w, i) => {
    const weekEndDate = parseWeekEnd(w.label);
    const isPast = weekEndDate && weekEndDate < todayMidnight;
    const isCurrentWeek = !isPast && weekEndDate && weekEndDate >= todayMidnight;
    const collapsedClass = isPast ? 'collapsed' : '';
    const pastBadge = isPast ? '<span class="week-past-badge">PAST</span>' : '';

    const modeClassMap = {'Cash':'due-detail-mode-cash','Check':'due-detail-mode-check','Bank Transfer':'due-detail-mode-transfer','GCash':'due-detail-mode-gcash'};

    const detailRows = w.dues.map(d => `
      <div class="due-detail-row">
        <div class="due-detail-supplier">${escHtml(d.supplier)}</div>
        <div class="due-detail-line">
          <span class="due-detail-amount">â‚± ${formatPeso(d.amount)}</span>
          <span>Â·</span>
          <span>${formatDate(d.dueDate)}</span>
          <span>Â·</span>
          <span class="due-detail-mode-badge ${modeClassMap[d.mode] || ''}">${escHtml(d.mode)}</span>
        </div>
      </div>
    `).join('');

    // â”€â”€ Threshold block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let thresholdHtml = '';
    if (weeklyThreshold > 0) {
      const remaining = weeklyThreshold - w.total;
      const pct       = Math.min((w.total / weeklyThreshold) * 100, 100);
      const isOver    = w.total >= weeklyThreshold;
      const isWarn    = !isOver && pct >= 80;

      const barClass      = isOver ? 'over' : isWarn ? 'warn' : '';
      const statusClass   = isOver ? 'over' : isWarn ? 'warn' : 'safe';
      const remainingText = isOver
        ? 'âš  EXCEEDED by â‚±' + formatPeso(w.total - weeklyThreshold)
        : 'â‚±' + formatPeso(remaining) + ' remaining';

      const banner = isOver
        ? `<div class="threshold-exceeded-banner">ğŸš¨ Weekly limit exceeded by â‚±${formatPeso(w.total - weeklyThreshold)}!</div>`
        : isWarn
        ? `<div class="threshold-warn-banner">âš ï¸ Nearing limit â€” ${Math.round(pct)}% used</div>`
        : '';

      // Fire toast for current week only, once per render
      if (!hasAlerted && !isPast) {
        if (isOver) {
          hasAlerted = true;
          setTimeout(() => showToast('ğŸš¨ Weekly limit EXCEEDED for ' + w.label + '!', 'error'), 300);
        } else if (isWarn) {
          hasAlerted = true;
          setTimeout(() => showToast('âš ï¸ Nearing weekly limit â€” ' + Math.round(pct) + '% used', 'error'), 300);
        }
      }

      thresholdHtml = `
        ${banner}
        <div class="threshold-bar-wrap">
          <div class="threshold-bar ${barClass}" style="width:${pct}%"></div>
        </div>
        <div class="threshold-status">
          <span class="ts-remaining ${statusClass}">${remainingText}</span>
          <span>â‚±${formatPeso(weeklyThreshold)} limit</span>
        </div>`;
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    return `
    <div class="week-card ${collapsedClass}" id="wcard-${i}">
      <div class="week-card-header" onclick="toggleWeekCard(${i})">
        <div class="week-card-meta">
          <div class="week-range">${w.label}${pastBadge}</div>
          <div class="week-total">â‚± ${formatPeso(w.total)}</div>
          <div class="week-count">${w.count} due${w.count !== 1 ? 's' : ''}</div>
        </div>
        <div class="week-card-chevron">â–¾</div>
      </div>
      <div class="week-card-body">
        <div class="week-card-body-inner">
          ${thresholdHtml}
          ${detailRows}
          <button class="tg-btn" onclick="openPicker(${i})" style="margin-top:8px;">ğŸ“¨ Send to Telegram</button>
        </div>
      </div>
    </div>`;
  }).join('');
  window.__weeks = weeks;
}

function toggleWeekCard(i) {
  const card = document.getElementById('wcard-' + i);
  if (card) card.classList.toggle('collapsed');
}

// Parse the end date from a label like "Jan 15 â€“ 21, 2025" or "Jan 29 â€“ Feb 4, 2025"
function parseWeekEnd(label) {
  try {
    const mo = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
    // "MMM D â€“ D, YYYY"  same month
    let m = label.match(/^(\w+)\s+\d+\s*[â€“-]\s*(\d+),\s*(\d{4})$/);
    if (m) return new Date(+m[3], mo[m[1]], +m[2]);
    // "MMM D â€“ MMM D, YYYY"  different months, same year
    m = label.match(/^\w+\s+\d+\s*[â€“-]\s*(\w+)\s+(\d+),\s*(\d{4})$/);
    if (m) return new Date(+m[3], mo[m[1]], +m[2]);
    // "MMM D, YYYY â€“ MMM D, YYYY"
    m = label.match(/[â€“-]\s*(\w+)\s+(\d+),\s*(\d{4})$/);
    if (m) return new Date(+m[3], mo[m[1]], +m[2]);
    return null;
  } catch(e) { return null; }
}

function groupByWeeks(dues) {
  if (!dues.length) return [];
  const dates = dues.map(d => d.dueDate).sort();
  const firstDate = new Date(dates[0] + 'T00:00:00');
  const lastDate  = new Date(dates[dates.length-1] + 'T00:00:00');
  const startSat  = new Date(firstDate);
  const dow = startSat.getDay();
  startSat.setDate(startSat.getDate() - (dow === 6 ? 0 : dow + 1));
  const weeks = [];
  let cur = new Date(startSat);
  while (cur <= lastDate) {
    const weekStart = new Date(cur);
    const weekEnd   = new Date(cur); weekEnd.setDate(weekEnd.getDate() + 6);
    const weekDues  = dues.filter(d => { const dt = new Date(d.dueDate + 'T00:00:00'); return dt >= weekStart && dt <= weekEnd; });
    if (weekDues.length) weeks.push({ label: fmtRange(weekStart, weekEnd), total: weekDues.reduce((s,d) => s+d.amount, 0), count: weekDues.length, dues: weekDues });
    cur.setDate(cur.getDate() + 7);
  }
  return weeks;
}

function fmtRange(a, b) {
  const mo = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  if (a.getMonth() === b.getMonth() && a.getFullYear() === b.getFullYear())
    return `${mo[a.getMonth()]} ${a.getDate()} â€“ ${b.getDate()}, ${b.getFullYear()}`;
  if (a.getFullYear() === b.getFullYear())
    return `${mo[a.getMonth()]} ${a.getDate()} â€“ ${mo[b.getMonth()]} ${b.getDate()}, ${b.getFullYear()}`;
  return `${mo[a.getMonth()]} ${a.getDate()}, ${a.getFullYear()} â€“ ${mo[b.getMonth()]} ${b.getDate()}, ${b.getFullYear()}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORE / MONTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStore(s) {
  currentStore = s;
  loadThreshold();
  document.getElementById('btn-main').className   = 'store-btn' + (s === 'MAIN'   ? ' active-main'   : '');
  document.getElementById('btn-branch').className = 'store-btn' + (s === 'BRANCH' ? ' active-branch' : '');
  const pill = document.getElementById('store-pill');
  pill.textContent = s; pill.className = 'store-pill ' + (s === 'MAIN' ? 'pill-main' : 'pill-branch');
  loadDues();
}
function changeMonth(dir) {
  viewMonth += dir;
  if (viewMonth > 11) { viewMonth = 0;  viewYear++; }
  if (viewMonth < 0)  { viewMonth = 11; viewYear--; }
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatPeso(n) { return Number(n).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function formatDate(str) { const d = new Date(str + 'T00:00:00'); return d.toLocaleDateString('en-PH', { year: 'numeric', month: 'short', day: 'numeric' }); }
function formatAmountInput(el) {
  let raw = el.value.replace(/[^0-9.]/g,'');
  const parts = raw.split('.');
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,',');
  el.value = parts.length > 2 ? parts[0] + '.' + parts.slice(1).join('') : parts.join('.');
}
function escHtml(str) { return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function clearForm() {
  document.getElementById('f-date').value = ''; document.getElementById('f-amount').value = '';
  document.getElementById('f-supplier').value = ''; document.getElementById('f-mode').value = 'Cash';
}
let toastTimer;
function showToast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.className = ''; }, 3500);
}

document.getElementById('f-date').value = today.toISOString().slice(0,10);
loadTgSettings();
</script>
</body>
</html>
